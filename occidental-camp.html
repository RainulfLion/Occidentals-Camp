<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Occidental Camp Layout - Gallows Humor Gaming</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #654321 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4a3728 0%, #6b4423 100%);
            color: white;
            padding: 20px 50px;
            text-align: center;
            border-bottom: 4px solid #d4a574;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 30px;
            width: 100%;
            max-width: 1200px;
        }

        .header-logo {
            width: 240px;
            height: 240px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .header-text {
            text-align: center;
            flex: 1;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-wrap: wrap;
                justify-content: center;
            }
            .header-logo {
                width: 150px;
                height: 150px;
            }
        }

        /* Responsive styles for mobile */
        @media (max-width: 1200px) {
            .workspace {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-height: 300px;
                border-left: none;
                border-top: 2px solid #d4a574;
            }
        }

        @media (max-width: 900px) {
            .toolbar {
                padding: 10px 15px;
                gap: 8px;
            }
            .toolbar-group {
                padding: 4px 8px;
                gap: 6px;
            }
            .toolbar button {
                padding: 8px 12px;
                font-size: 12px;
            }
            .toolbar label {
                font-size: 12px;
            }
            .color-swatch {
                width: 24px;
                height: 24px;
            }
            .header {
                padding: 15px 20px;
                min-height: 100px;
            }
            .header h1 {
                font-size: 1.5em;
            }
            .header-logo {
                width: 80px;
                height: 80px;
            }
        }

        @media (max-width: 600px) {
            .toolbar-group {
                border-right: none;
                border-bottom: 1px solid #d4a574;
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            .toolbar-group:last-child {
                border-bottom: none;
            }
            .zoom-controls {
                bottom: 20px;
                right: 10px;
            }
            .map-size-controls {
                bottom: 20px;
                left: 10px;
            }
            .sidebar {
                max-height: 250px;
                padding: 15px;
            }
            .header-content {
                gap: 10px;
            }
            .header-logo {
                width: 60px;
                height: 60px;
            }
            .header h1 {
                font-size: 1.2em;
            }
            .header p {
                font-size: 0.8em;
            }
        }

        /* Map size controls */
        .map-size-controls {
            position: fixed;
            bottom: 80px;
            left: 30px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .map-size-controls label {
            display: block;
            font-size: 11px;
            color: #4a3728;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .map-size-controls select {
            padding: 8px 12px;
            border: 2px solid #8B4513;
            border-radius: 4px;
            background: white;
            color: #4a3728;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
        }

        .map-size-controls select:focus {
            outline: none;
            border-color: #d4a574;
        }

        .nav-bar {
            background: #5c3d2e;
            padding: 10px 30px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-bar a {
            color: #f5deb3;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .nav-bar a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-bar a.active {
            background: #d4a574;
            color: #3d2817;
        }

        .toolbar {
            background: #f8f5f0;
            padding: 20px 30px;
            border-bottom: 2px solid #d4a574;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 5px 10px;
            border-right: 2px solid #d4a574;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .color-palette {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .color-swatch {
            width: 30px;
            height: 30px;
            border: 2px solid #333;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-swatch:hover {
            transform: scale(1.2);
        }

        .color-swatch.selected {
            border: 3px solid #ffd700;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }

        .zoom-controls {
            position: fixed;
            bottom: 80px;
            right: 30px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .zoom-controls button {
            width: 40px;
            height: 40px;
            background: #8B4513;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zoom-controls button:hover {
            background: #654321;
            transform: scale(1.1);
        }

        .zoom-level {
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: #4a3728;
        }

        .compass-indicator {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: #f5deb3;
            padding: 8px 12px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #8B4513;
        }

        .compass-indicator:hover {
            transform: translateX(-50%) scale(1.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .compass-letter {
            font-size: 16px;
            font-weight: bold;
            color: #4a3728;
            text-align: center;
            user-select: none;
            line-height: 1;
        }

        .compass-label {
            font-size: 7px;
            text-align: center;
            color: #666;
            margin-top: 1px;
            text-transform: uppercase;
            line-height: 1;
        }

        .toolbar button {
            background: #8B4513;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .toolbar button:hover {
            background: #654321;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.4);
        }

        .toolbar button.active {
            background: #228B22;
            box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.3);
        }

        .toolbar button.danger {
            background: #8B0000;
        }

        .toolbar button.danger:hover {
            background: #660000;
        }

        .toolbar input[type="file"] {
            display: none;
        }

        .toolbar label {
            background: #6b4423;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
        }

        .toolbar label:hover {
            background: #4a3728;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 68, 35, 0.4);
        }

        .workspace {
            display: flex;
            height: calc(100vh - 280px);
            min-height: 500px;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, #c2b280 0%, #8fbc8f 100%);
            overflow: auto;
        }

        .canvas {
            width: 3000px;
            height: 2000px;
            position: relative;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
            touch-action: none;
            will-change: transform;
        }

        .tent {
            position: absolute;
            background: linear-gradient(135deg, #d4a574 0%, #c19660 100%);
            border: 3px solid #8B4513;
            border-radius: 8px;
            cursor: move;
            user-select: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            touch-action: none;
            will-change: transform;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .tent:hover {
            transform: scale(1.05);
            z-index: 100 !important;
        }

        .tent.selected {
            border-color: #ffd700;
            border-width: 4px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .tent-label {
            color: #3d2817;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            padding: 5px;
            word-break: break-word;
            max-width: 90%;
        }

        .tent-size {
            color: rgba(61, 40, 23, 0.8);
            font-size: 11px;
            margin-top: 3px;
        }

        .tent.round {
            border-radius: 50%;
        }

        .rotate-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #228B22;
            border: 2px solid #145214;
            border-radius: 50%;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            cursor: grab;
            z-index: 10;
        }

        .rotate-handle:active {
            cursor: grabbing;
        }

        .rotate-handle::before {
            content: '\21BB';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .drawing-canvas.active {
            pointer-events: auto;
        }

        .drawing-canvas.pencil-active {
            pointer-events: auto;
            z-index: 15;
        }

        .canvas.line-mode {
            cursor: crosshair;
        }

        .canvas.pencil-mode {
            cursor: crosshair;
        }

        .line-preview {
            position: absolute;
            height: 2px;
            background: #4a3728;
            pointer-events: none;
            z-index: 6;
            transform-origin: left center;
        }

        .line-label {
            position: absolute;
            background: rgba(74, 55, 40, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            z-index: 7;
            white-space: nowrap;
        }

        .sidebar {
            width: 300px;
            background: #f8f5f0;
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #d4a574;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #4a3728;
        }

        .bg-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #d4a574;
        }

        .bg-controls label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }

        .size-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .size-control button {
            width: 35px;
            height: 35px;
            background: #8B4513;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .size-control button:hover {
            background: #654321;
            transform: scale(1.1);
        }

        .size-control span {
            flex: 1;
            text-align: center;
            font-weight: 600;
            color: #4a3728;
        }

        .property-group {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #d4a574;
        }

        .property-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }

        .property-group input {
            width: 100%;
            padding: 8px;
            border: 2px solid #d4a574;
            border-radius: 4px;
            font-size: 0.95em;
        }

        .property-group input:focus {
            outline: none;
            border-color: #8B4513;
        }

        .size-inputs {
            display: flex;
            gap: 10px;
        }

        .size-inputs input {
            flex: 1;
        }

        .tent-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .tent-item {
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .tent-item:hover {
            background: #f5deb3;
            border-color: #8B4513;
        }

        .tent-item.selected {
            background: #d4a574;
            border-color: #8B4513;
        }

        .tent-item-name {
            font-weight: bold;
            color: #4a3728;
        }

        .tent-item-size {
            font-size: 0.85em;
            color: #666;
        }

        .no-selection {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .hint {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(74, 55, 40, 0.9);
            color: #f5deb3;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85em;
            z-index: 1000;
        }

        .camp-info {
            background: #f5deb3;
            border: 2px solid #8B4513;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .camp-info h4 {
            color: #4a3728;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .camp-info ul {
            color: #5c3d2e;
            font-size: 0.9em;
            padding-left: 0;
            list-style: none;
        }

        .camp-info li {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .guide-item {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #c4956a;
            border-radius: 4px;
            background: #fff8f0;
            color: #5c3d2e;
            font-size: 0.9em;
            font-family: inherit;
        }

        .guide-item:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 0 0 4px rgba(139, 69, 19, 0.3);
        }

        .guide-delete-btn {
            background: #8B0000;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .guide-delete-btn:hover {
            background: #a00000;
        }

        .guide-add-btn {
            background: #4a3728;
            color: #f5deb3;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 8px;
            width: 100%;
        }

        .guide-add-btn:hover {
            background: #5c3d2e;
        }

        /* ── Firebase Auth UI ── */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #4a3728 0%, #8B4513 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-box {
            background: white;
            border-radius: 16px;
            padding: 48px 40px 40px;
            text-align: center;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .login-box .login-logo {
            width: 140px;
            height: 140px;
            object-fit: contain;
            margin-bottom: 18px;
        }

        .login-box h2 {
            color: #4a3728;
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .login-box p {
            color: #7a5c4a;
            font-size: 0.93em;
            margin-bottom: 28px;
            line-height: 1.5;
        }

        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: white;
            border: 2px solid #d4a574;
            border-radius: 8px;
            padding: 14px 24px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #4a3728;
            width: 100%;
            transition: background 0.2s, border-color 0.2s;
            font-family: inherit;
        }

        .google-signin-btn:hover {
            background: #fdf3e7;
            border-color: #8B4513;
        }

        .google-signin-btn svg { width: 20px; height: 20px; flex-shrink: 0; }

        .login-error {
            color: #8B0000;
            font-size: 0.83em;
            margin-top: 12px;
            min-height: 1em;
        }

        /* User bar in header */
        .user-bar {
            display: none;
            align-items: center;
            gap: 8px;
            position: absolute;
            top: 12px;
            right: 16px;
            background: rgba(0,0,0,0.25);
            padding: 6px 12px;
            border-radius: 8px;
        }

        .user-bar img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #d4a574;
            object-fit: cover;
        }

        .user-bar .user-name {
            color: #f5deb3;
            font-size: 0.82em;
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-bar .signout-btn {
            background: rgba(255,255,255,0.18);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.78em;
            font-family: inherit;
        }

        .user-bar .signout-btn:hover { background: rgba(255,255,255,0.3); }

        /* Sync status toast */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(74, 55, 40, 0.92);
            color: #f5deb3;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.82em;
            z-index: 5000;
            display: none;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        /* Setup notice */
        .firebase-setup-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.82em;
            color: #856404;
            margin-top: 16px;
            text-align: left;
            line-height: 1.5;
        }

        .firebase-setup-notice code {
            background: #f8d7a0;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <!-- Login overlay – hidden once user is authenticated -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <img src="https://rainulflion.github.io/Occidental.png" alt="Occidental Camp" class="login-logo">
            <h2>Occidental Camp Layout</h2>
            <p>Sign in to view and edit the camp layout.<br>All changes sync instantly with your group.</p>
            <button class="google-signin-btn" onclick="signInWithGoogle()">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Sign in with Google
            </button>
            <div id="loginError" class="login-error"></div>
            <div class="firebase-setup-notice" id="firebaseSetupNotice" style="display:none">
                <strong>Firebase not configured yet.</strong><br>
                Open <code>occidental-camp.html</code>, find the <code>firebaseConfig</code> block near the top of the
                <code>&lt;script&gt;</code> section, and replace the placeholder values with your Firebase project
                credentials. See the comments above the config for step-by-step instructions.
            </div>
        </div>
    </div>

    <!-- Sync status toast -->
    <div id="syncStatus" class="sync-status"></div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="https://rainulflion.github.io/Occidental.png" alt="Occidental Camp" class="header-logo">
                <div class="header-text">
                    <h1>Occidental Camp Layout</h1>
                    <p>Medieval & Historical Camp Planning for Gallows Humor Gaming</p>
                </div>
                <img src="https://rainulflion.github.io/Occidental.png" alt="Occidental Camp" class="header-logo">
            </div>
            <!-- Signed-in user info -->
            <div class="user-bar" id="userBar">
                <img id="userPhoto" src="" alt="User avatar">
                <span class="user-name" id="userName"></span>
                <button class="signout-btn" onclick="signOut()">Sign Out</button>
            </div>
        </div>

        <div class="nav-bar">
            <a href="index.html">Camp Planner</a>
            <a href="occidental-camp.html" class="active">Occidental Camp</a>
        </div>

        <div class="toolbar">
            <div class="toolbar-group">
                <button onclick="addTent('square')">Add Square Tent</button>
                <button onclick="addTent('round')">Add Round Tent</button>
            </div>
            <div class="toolbar-group">
                <span style="font-weight: 600; color: #4a3728;">Tent Color:</span>
                <div class="color-palette">
                    <div class="color-swatch" style="background: #8B4513;" onclick="selectTentColor('brown')" data-color="brown"></div>
                    <div class="color-swatch selected" style="background: #d4a574;" onclick="selectTentColor('tan')" data-color="tan"></div>
                    <div class="color-swatch" style="background: #8B0000;" onclick="selectTentColor('darkred')" data-color="darkred"></div>
                    <div class="color-swatch" style="background: #2F4F4F;" onclick="selectTentColor('darkgreen')" data-color="darkgreen"></div>
                    <div class="color-swatch" style="background: #4a3728;" onclick="selectTentColor('darkbrown')" data-color="darkbrown"></div>
                    <div class="color-swatch" style="background: #f5f5dc;" onclick="selectTentColor('cream')" data-color="cream"></div>
                </div>
            </div>
            <div class="toolbar-group">
                <button id="lineBtn" onclick="toggleLineTool()">Line Tool</button>
                <button id="deleteLineBtn" onclick="toggleDeleteLineMode()">Delete Lines</button>
                <button id="pencilBtn" onclick="togglePencilTool()">Pencil Tool</button>
                <button id="deletePencilBtn" onclick="toggleDeletePencilMode()">Delete Pencil</button>
            </div>
            <div class="toolbar-group">
                <label for="bgImageUpload">Upload Background</label>
                <input type="file" id="bgImageUpload" accept="image/*" onchange="handleBackgroundUpload(event)">
                <button onclick="removeBackground()">Remove Background</button>
            </div>
            <div class="toolbar-group">
                <button class="danger" onclick="deleteSelected()">Delete Selected</button>
                <button onclick="clearAll()">Clear All</button>
                <label for="jsonUpload">Load Layout</label>
                <input type="file" id="jsonUpload" accept="application/json,.json" onchange="handleJsonUpload(event)">
                <button onclick="exportLayout()">Export Layout</button>
            </div>
            <div class="toolbar-group">
                <button onclick="saveToBrowser()" title="Save your camp layout to browser storage">Save to Browser</button>
                <button onclick="loadFromBrowser()" title="Load saved layout from browser storage">Load Saved</button>
                <button onclick="exportAsImage()" title="Export camp as PNG image">Export Image</button>
            </div>
        </div>

        <div class="workspace">
            <div class="canvas-container">
                <div class="compass-indicator" onclick="cycleCompassDirection()" title="Click to change direction">
                    <div class="compass-letter" id="compassLetter">N</div>
                    <div class="compass-label" id="compassLabel">North</div>
                </div>
                <div class="canvas" id="canvas">
                    <canvas class="drawing-canvas" id="pencilCanvas"></canvas>
                    <canvas class="drawing-canvas" id="drawingCanvas"></canvas>
                    <svg class="grid-overlay" id="gridOverlay"></svg>
                </div>
                <div class="hint">
                    Drag tents to move | Rotate with green handle | Line tool measures distances in feet
                </div>
            </div>

            <div class="zoom-controls">
                <button onclick="zoomIn()">+</button>
                <div class="zoom-level" id="zoomLevel">100%</div>
                <button onclick="zoomOut()">-</button>
            </div>

            <div class="map-size-controls">
                <label>Map Size</label>
                <select id="mapSizeSelect" onchange="changeMapSize(this.value)">
                    <option value="1500x1000">Small (150x100 ft)</option>
                    <option value="2000x1500">Medium (200x150 ft)</option>
                    <option value="3000x2000" selected>Large (300x200 ft)</option>
                    <option value="4000x3000">X-Large (400x300 ft)</option>
                </select>
            </div>

            <div class="sidebar">
                <div class="camp-info">
                    <h4>Occidental Camp Guide</h4>
                    <ul id="campGuideList">
                        <li><input type="text" class="guide-item" value="Main Pavilion - Central command tent"><button class="guide-delete-btn" onclick="deleteGuideItem(this)">&times;</button></li>
                        <li><input type="text" class="guide-item" value="Guard Posts - Strategic placement"><button class="guide-delete-btn" onclick="deleteGuideItem(this)">&times;</button></li>
                        <li><input type="text" class="guide-item" value="Cooking Area - Downwind location"><button class="guide-delete-btn" onclick="deleteGuideItem(this)">&times;</button></li>
                        <li><input type="text" class="guide-item" value="Storage Tents - Gear and supplies"><button class="guide-delete-btn" onclick="deleteGuideItem(this)">&times;</button></li>
                        <li><input type="text" class="guide-item" value="Sleeping Quarters - Personal tents"><button class="guide-delete-btn" onclick="deleteGuideItem(this)">&times;</button></li>
                    </ul>
                    <button class="guide-add-btn" onclick="addGuideItem()">+ Add Item</button>
                </div>

                <div class="bg-controls" id="bgControls" style="display: none;">
                    <h3>Background Image</h3>
                    <label>Size Control:</label>
                    <div class="size-control">
                        <button onclick="adjustBackgroundSize(-10)">-</button>
                        <span id="bgSizeDisplay">100%</span>
                        <button onclick="adjustBackgroundSize(10)">+</button>
                    </div>
                </div>

                <h3>Tent Properties</h3>
                <div id="propertiesPanel">
                    <div class="no-selection">
                        Select a tent to edit its properties
                    </div>
                </div>

                <h3 style="margin-top: 30px;">All Tents</h3>
                <div class="tent-list" id="tentList"></div>
            </div>
        </div>
    </div>

    <script>
        // ================================================================
        // FIREBASE CONFIGURATION
        // ================================================================
        // HOW TO SET UP:
        //  1. Go to https://console.firebase.google.com/
        //  2. Click "Add project" and follow the steps
        //  3. In your project, click "Add app" > Web (</>)
        //  4. Register the app, then copy the config object below
        //  5. Authentication → Sign-in method → Enable "Google"
        //  6. Firestore Database → Create database → Production mode
        //  7. Firestore → Rules tab → replace with:
        //       rules_version = '2';
        //       service cloud.firestore {
        //         match /databases/{database}/documents {
        //           match /{document=**} {
        //             allow read, write: if request.auth != null;
        //           }
        //         }
        //       }
        // ================================================================
        const firebaseConfig = {
            apiKey:            "AIzaSyCMBdhIAXtZn6x1RYVcQRIqbqXgNlOnTWI",
            authDomain:        "camplayout-8e090.firebaseapp.com",
            projectId:         "camplayout-8e090",
            storageBucket:     "camplayout-8e090.firebasestorage.app",
            messagingSenderId: "858545109189",
            appId:             "1:858545109189:web:cea393333ea7c6636d58ac"
        };

        const FIREBASE_CONFIGURED = firebaseConfig.apiKey !== "YOUR_API_KEY";

        let auth, db;
        if (FIREBASE_CONFIGURED) {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db   = firebase.firestore();
        } else {
            // Not configured yet – show a setup notice inside the login box
            document.addEventListener('DOMContentLoaded', () => {
                const notice = document.getElementById('firebaseSetupNotice');
                if (notice) notice.style.display = 'block';
            });
        }

        // ── Sync helpers ──────────────────────────────────────────────
        let _saveTimer   = null;
        let _localChange = false;
        let _unsubSync   = null;

        function _showSync(msg) {
            const el = document.getElementById('syncStatus');
            if (!el) return;
            el.textContent = msg;
            el.style.display = 'block';
            el.style.opacity = '1';
        }
        function _hideSync() {
            const el = document.getElementById('syncStatus');
            if (!el) return;
            el.style.opacity = '0';
            setTimeout(() => { el.style.display = 'none'; }, 350);
        }

        /** Call this after any change to schedule a debounced Firestore save. */
        function scheduleFirestoreSave() {
            if (!FIREBASE_CONFIGURED || !auth || !auth.currentUser) return;
            clearTimeout(_saveTimer);
            _localChange = true;
            _showSync('Saving…');
            _saveTimer = setTimeout(async () => {
                await _saveToFirestore();
                _showSync('Saved ✓');
                setTimeout(() => {
                    _hideSync();
                    setTimeout(() => { _localChange = false; }, 600);
                }, 1800);
            }, 1400);
        }

        function _getLayoutData() {
            const mapSizeSelect = document.getElementById('mapSizeSelect');
            const mapSize = mapSizeSelect ? mapSizeSelect.value : '3000x2000';
            const guideItems = [];
            document.querySelectorAll('#campGuideList .guide-item').forEach(inp => {
                guideItems.push(inp.value);
            });
            return {
                tents:            tents.map(t => ({ ...t })),
                lines:            lines,
                pencilStrokes:    pencilStrokes,
                backgroundSize:   backgroundSize,
                compassDirection: compassDirection,
                mapSize:          mapSize,
                guideItems:       guideItems,
                savedAt:          new Date().toISOString(),
                savedBy:          auth.currentUser ? auth.currentUser.email : 'unknown'
                // backgroundImage intentionally omitted – base64 images exceed
                // Firestore's 1 MB document limit. Upload backgrounds locally.
            };
        }

        async function _saveToFirestore() {
            if (!auth || !auth.currentUser) return;
            try {
                await db.doc('layouts/occidentalCamp').set(_getLayoutData());
            } catch (err) {
                console.error('Firestore save error:', err);
                _showSync('Save failed!');
                setTimeout(_hideSync, 3000);
            }
        }

        function _applyGuideItems(items) {
            if (!items) return;
            const list = document.getElementById('campGuideList');
            if (!list) return;
            list.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<input type="text" class="guide-item" value="${item.replace(/"/g, '&quot;')}"><button class="guide-delete-btn" onclick="deleteGuideItem(this)">&times;</button>`;
                list.appendChild(li);
            });
            list.querySelectorAll('.guide-item').forEach(inp => {
                inp.addEventListener('change', saveCampGuide);
                inp.addEventListener('blur',   saveCampGuide);
            });
        }

        async function _loadFromFirestore() {
            try {
                const snap = await db.doc('layouts/occidentalCamp').get();
                if (snap.exists) {
                    const data = snap.data();
                    loadLayout(data);
                    _applyGuideItems(data.guideItems);
                } else {
                    // First run – seed with the default Occidental layout
                    initializeOccidentalCamp();
                    await _saveToFirestore();
                }
            } catch (err) {
                console.error('Firestore load error:', err);
                initializeOccidentalCamp();
            }
        }

        function _setupRealtimeSync() {
            if (_unsubSync) _unsubSync();
            _unsubSync = db.doc('layouts/occidentalCamp').onSnapshot(snap => {
                if (!snap.exists || _localChange) return;
                const data = snap.data();
                // Only apply if it was saved by someone else
                if (data.savedBy !== (auth.currentUser && auth.currentUser.email)) {
                    _showSync('Syncing changes…');
                    loadLayout(data);
                    _applyGuideItems(data.guideItems);
                    setTimeout(_hideSync, 2200);
                }
            }, err => console.error('Realtime sync error:', err));
        }

        // ── Auth functions (called from HTML) ─────────────────────────
        function signInWithGoogle() {
            if (!FIREBASE_CONFIGURED) return;
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(err => {
                const el = document.getElementById('loginError');
                if (el) el.textContent = 'Sign-in failed: ' + err.message;
            });
        }

        function signOut() {
            if (!auth) return;
            if (_unsubSync) { _unsubSync(); _unsubSync = null; }
            auth.signOut();
        }

        // ── Auth state listener ───────────────────────────────────────
        if (FIREBASE_CONFIGURED) {
            auth.onAuthStateChanged(async user => {
                const overlay = document.getElementById('loginOverlay');
                const userBar = document.getElementById('userBar');
                if (user) {
                    if (overlay) overlay.style.display = 'none';
                    if (userBar) {
                        userBar.style.display = 'flex';
                        document.getElementById('userName').textContent =
                            user.displayName || user.email;
                        const photoEl = document.getElementById('userPhoto');
                        if (user.photoURL) {
                            photoEl.src = user.photoURL;
                        } else {
                            photoEl.style.display = 'none';
                        }
                    }
                    await _loadFromFirestore();
                    _setupRealtimeSync();
                } else {
                    if (overlay) overlay.style.display = 'flex';
                    if (userBar)  userBar.style.display  = 'none';
                    if (_unsubSync) { _unsubSync(); _unsubSync = null; }
                }
            });
        }

        // ================================================================
        // END FIREBASE SETUP – existing app code below
        // ================================================================

        let tents = [];
        let borders = [];
        let selectedTent = null;
        let isDragging = false;
        let isRotating = false;
        let isDrawing = false;
        let lineMode = false;
        let pencilMode = false;
        let deleteLineMode = false;
        let deletePencilMode = false;
        let dragOffset = { x: 0, y: 0 };
        let rotateStartAngle = 0;
        let tentCounter = 1;
        let borderCounter = 1;

        // Conversion: 1 foot = 10 pixels (adjustable scale)
        const PIXELS_PER_FOOT = 10;

        // Zoom variables
        let zoomLevel = 1.0;
        const zoomStep = 0.1;
        const minZoom = 0.3;
        const maxZoom = 3.0;

        // Medieval/Occidental color palette
        let currentTentColor = 'tan';
        const tentColors = {
            brown: { bg: '#8B4513', border: '#5c2d0e', textColor: '#f5deb3' },
            tan: { bg: '#d4a574', border: '#8B4513', textColor: '#3d2817' },
            darkred: { bg: '#8B0000', border: '#4a0000', textColor: '#f5deb3' },
            darkgreen: { bg: '#2F4F4F', border: '#1a2f2f', textColor: '#f5deb3' },
            darkbrown: { bg: '#4a3728', border: '#2d221a', textColor: '#f5deb3' },
            cream: { bg: '#f5f5dc', border: '#8B4513', textColor: '#3d2817' }
        };

        // Compass direction
        let compassDirection = 'N';
        const compassDirections = [
            { letter: 'N', label: 'North' },
            { letter: 'E', label: 'East' },
            { letter: 'S', label: 'South' },
            { letter: 'W', label: 'West' }
        ];
        let compassIndex = 0;

        // Drawing/Line variables
        let drawingCanvas;
        let drawingCtx;
        let pencilCanvas;
        let pencilCtx;
        let lines = [];
        let pencilStrokes = [];
        let currentStroke = [];
        let currentLine = null;
        let lineStartX = 0;
        let lineStartY = 0;
        let linePreview = null;
        let lineLabel = null;
        let lastPencilX = 0;
        let lastPencilY = 0;

        // Background variables
        let backgroundSize = 100;
        let backgroundImage = null;

        function feetToPixels(feet) {
            return feet * PIXELS_PER_FOOT;
        }

        function pixelsToFeet(pixels) {
            return Math.round((pixels / PIXELS_PER_FOOT) * 10) / 10;
        }

        const canvas = document.getElementById('canvas');
        const canvasContainer = document.querySelector('.canvas-container');

        // Zoom functions
        function updateZoom() {
            canvas.style.transform = `scale(${zoomLevel})`;
            document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
        }

        function zoomIn() {
            if (zoomLevel < maxZoom) {
                zoomLevel = Math.min(maxZoom, zoomLevel + zoomStep);
                updateZoom();
            }
        }

        function zoomOut() {
            if (zoomLevel > minZoom) {
                zoomLevel = Math.max(minZoom, zoomLevel - zoomStep);
                updateZoom();
            }
        }

        // Map size control
        function changeMapSize(size) {
            const [width, height] = size.split('x').map(Number);
            const canvas = document.getElementById('canvas');
            const drawingCanvas = document.getElementById('drawingCanvas');
            const pencilCanvas = document.getElementById('pencilCanvas');

            // Update canvas size
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            // Update drawing canvases
            if (drawingCanvas) {
                drawingCanvas.width = width;
                drawingCanvas.height = height;
            }
            if (pencilCanvas) {
                pencilCanvas.width = width;
                pencilCanvas.height = height;
            }

            // Redraw lines if they exist
            if (typeof redrawLines === 'function') {
                redrawLines();
            }
            if (typeof redrawPencil === 'function') {
                redrawPencil();
            }

            // Save preference
            localStorage.setItem('occidentalMapSize', size);
            scheduleFirestoreSave();
        }

        // Load saved map size on page load
        function loadSavedMapSize() {
            const savedSize = localStorage.getItem('occidentalMapSize');
            if (savedSize) {
                const select = document.getElementById('mapSizeSelect');
                if (select) {
                    select.value = savedSize;
                    changeMapSize(savedSize);
                }
            }
        }

        // Mouse wheel zoom
        canvasContainer.addEventListener('wheel', (e) => {
            e.preventDefault();

            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        }, { passive: false });

        // Color selection
        function selectTentColor(color) {
            currentTentColor = color;

            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('selected');
            });
            document.querySelector(`.color-swatch[data-color="${color}"]`).classList.add('selected');
        }

        function changeTentColor(color) {
            if (selectedTent) {
                selectedTent.color = color;
                const tentEl = document.getElementById(selectedTent.id);
                const colorScheme = tentColors[color];
                tentEl.style.background = colorScheme.bg;
                tentEl.style.borderColor = colorScheme.border;
                const label = tentEl.querySelector('.tent-label');
                if (label) {
                    label.style.color = colorScheme.textColor;
                }
                scheduleFirestoreSave();
            }
        }

        // Camp Guide functions
        function addGuideItem() {
            const list = document.getElementById('campGuideList');
            const li = document.createElement('li');
            li.innerHTML = '<input type="text" class="guide-item" value="" placeholder="Enter guide item..."><button class="guide-delete-btn" onclick="deleteGuideItem(this)">&times;</button>';
            list.appendChild(li);
            li.querySelector('input').focus();
            saveCampGuide();
        }

        function deleteGuideItem(btn) {
            const li = btn.parentElement;
            li.remove();
            saveCampGuide();
        }

        function saveCampGuide() {
            const items = [];
            document.querySelectorAll('#campGuideList .guide-item').forEach(input => {
                items.push(input.value);
            });
            localStorage.setItem('occidentalCampGuide', JSON.stringify(items));
            scheduleFirestoreSave();
        }

        function loadCampGuide() {
            const saved = localStorage.getItem('occidentalCampGuide');
            if (saved) {
                const items = JSON.parse(saved);
                const list = document.getElementById('campGuideList');
                list.innerHTML = '';
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<input type="text" class="guide-item" value="${item.replace(/"/g, '&quot;')}"><button class="guide-delete-btn" onclick="deleteGuideItem(this)">&times;</button>`;
                    list.appendChild(li);
                });
            }
            // Add event listeners for auto-save
            document.querySelectorAll('#campGuideList .guide-item').forEach(input => {
                input.addEventListener('change', saveCampGuide);
                input.addEventListener('blur', saveCampGuide);
            });
        }

        // Initialize camp guide and map size on load
        document.addEventListener('DOMContentLoaded', function() {
            loadCampGuide();
            loadSavedMapSize();
        });

        // Also save when new items are added - attach listeners
        const campGuideList = document.getElementById('campGuideList');
        if (campGuideList) {
            campGuideList.addEventListener('input', function(e) {
                if (e.target.classList.contains('guide-item')) {
                    saveCampGuide();
                }
            });
        }

        // Compass direction cycling
        function cycleCompassDirection() {
            compassIndex = (compassIndex + 1) % compassDirections.length;
            const direction = compassDirections[compassIndex];
            compassDirection = direction.letter;

            document.getElementById('compassLetter').textContent = direction.letter;
            document.getElementById('compassLabel').textContent = direction.label;
            scheduleFirestoreSave();
        }

        function addTent(shape = 'square') {
            const tent = {
                id: `tent-${tentCounter++}`,
                name: `Tent ${tentCounter - 1}`,
                x: 100 + (tents.length * 30) % 200,
                y: 100 + (tents.length * 30) % 150,
                width: 120,
                height: 120,
                shape: shape,
                rotation: 0,
                color: currentTentColor,
                zIndex: tents.length
            };
            tents.push(tent);
            renderTent(tent);
            updateTentList();
            scheduleFirestoreSave();
        }

        function renderTent(tent) {
            const tentEl = document.createElement('div');
            tentEl.className = 'tent';
            if (tent.shape === 'round') {
                tentEl.classList.add('round');
            }
            tentEl.id = tent.id;
            tentEl.style.left = tent.x + 'px';
            tentEl.style.top = tent.y + 'px';
            tentEl.style.width = tent.width + 'px';
            tentEl.style.height = tent.height + 'px';
            tentEl.style.zIndex = tent.zIndex + 10;
            tentEl.style.transform = `rotate(${tent.rotation}deg)`;

            const colorScheme = tentColors[tent.color] || tentColors.tan;
            tentEl.style.background = colorScheme.bg;
            tentEl.style.borderColor = colorScheme.border;

            const widthFeet = pixelsToFeet(tent.width);
            const heightFeet = pixelsToFeet(tent.height);
            const sizeText = tent.shape === 'round' ? `${widthFeet}ft diameter` : `${widthFeet}x${heightFeet}ft`;

            const rotateHandle = tent.shape === 'square' ? '<div class="rotate-handle"></div>' : '';

            tentEl.innerHTML = `
                <div class="tent-label" style="color: ${colorScheme.textColor}">
                    ${tent.name}
                    <div class="tent-size">${sizeText}</div>
                </div>
                ${rotateHandle}
            `;

            tentEl.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('rotate-handle')) {
                    startRotate(tent, e);
                } else {
                    startDrag(tent, e);
                }
            });

            tentEl.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                if (target.classList.contains('rotate-handle')) {
                    startRotate(tent, touch);
                } else {
                    startDrag(tent, touch);
                }
            });

            canvas.appendChild(tentEl);
        }

        function startDrag(tent, e) {
            if (lineMode || pencilMode || deleteLineMode || deletePencilMode) return;
            if (e.preventDefault) e.preventDefault();
            selectTent(tent);
            isDragging = true;
            const tentEl = document.getElementById(tent.id);
            const rect = tentEl.getBoundingClientRect();
            const clientX = e.clientX || e.pageX;
            const clientY = e.clientY || e.pageY;
            dragOffset.x = (clientX - rect.left) / zoomLevel;
            dragOffset.y = (clientY - rect.top) / zoomLevel;
        }

        function startRotate(tent, e) {
            if (e.preventDefault) e.preventDefault();
            if (e.stopPropagation) e.stopPropagation();
            selectTent(tent);
            isRotating = true;

            const clientX = e.clientX || e.pageX;
            const clientY = e.clientY || e.pageY;

            const tentEl = document.getElementById(tent.id);
            const rect = tentEl.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            rotateStartAngle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
        }

        function handleMove(e) {
            if (lineMode || pencilMode || deleteLineMode || deletePencilMode) return;

            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);

            if (!clientX || !clientY) return;

            if (isDragging && selectedTent) {
                const canvasRect = canvas.getBoundingClientRect();
                let newX = (clientX - canvasRect.left) / zoomLevel - dragOffset.x;
                let newY = (clientY - canvasRect.top) / zoomLevel - dragOffset.y;

                newX = Math.max(0, Math.min(newX, canvas.offsetWidth - selectedTent.width));
                newY = Math.max(0, Math.min(newY, canvas.offsetHeight - selectedTent.height));

                selectedTent.x = newX;
                selectedTent.y = newY;

                const tentEl = document.getElementById(selectedTent.id);
                tentEl.style.left = newX + 'px';
                tentEl.style.top = newY + 'px';
            } else if (isRotating && selectedTent) {
                const tentEl = document.getElementById(selectedTent.id);
                const rect = tentEl.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const currentAngle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
                const angleDiff = currentAngle - rotateStartAngle;

                selectedTent.rotation = (selectedTent.rotation + angleDiff + 360) % 360;
                tentEl.style.transform = `rotate(${selectedTent.rotation}deg)`;

                rotateStartAngle = currentAngle;
                updateProperties();
            }
        }

        document.addEventListener('mousemove', handleMove);
        document.addEventListener('touchmove', handleMove);

        function handleEnd() {
            if (isDragging || isRotating) scheduleFirestoreSave();
            isDragging = false;
            isRotating = false;
        }

        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchend', handleEnd);

        function selectTent(tent) {
            selectedTent = tent;
            document.querySelectorAll('.tent').forEach(el => el.classList.remove('selected'));
            document.getElementById(tent.id).classList.add('selected');
            updateProperties();
            updateTentList();
        }

        function updateProperties() {
            if (!selectedTent) {
                document.getElementById('propertiesPanel').innerHTML = `
                    <div class="no-selection">
                        Select a tent to edit its properties
                    </div>
                `;
                return;
            }

            const widthFeet = pixelsToFeet(selectedTent.width);
            const heightFeet = pixelsToFeet(selectedTent.height);

            const colorOptions = Object.keys(tentColors).map(color => {
                const colorScheme = tentColors[color];
                return `<div class="color-swatch ${selectedTent.color === color ? 'selected' : ''}" style="background: ${colorScheme.bg};" onclick="changeTentColor('${color}')"></div>`;
            }).join('');

            if (selectedTent.shape === 'round') {
                document.getElementById('propertiesPanel').innerHTML = `
                    <div class="property-group">
                        <label>Tent Name:</label>
                        <input type="text" id="tentName" value="${selectedTent.name}"
                               onchange="updateTentName(this.value)">
                    </div>
                    <div class="property-group">
                        <label>Shape:</label>
                        <input type="text" value="Round" disabled>
                    </div>
                    <div class="property-group">
                        <label>Color:</label>
                        <div class="color-palette">${colorOptions}</div>
                    </div>
                    <div class="property-group">
                        <label>Diameter (feet):</label>
                        <input type="number" id="tentDiameter" value="${widthFeet}"
                               min="2" step="0.5" onchange="updateTentDiameter()">
                    </div>
                    <div class="property-group">
                        <label>Position (X, Y):</label>
                        <div class="size-inputs">
                            <input type="number" id="tentX" value="${Math.round(selectedTent.x)}"
                                   min="0" onchange="updateTentPosition()">
                            <input type="number" id="tentY" value="${Math.round(selectedTent.y)}"
                                   min="0" onchange="updateTentPosition()">
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('propertiesPanel').innerHTML = `
                    <div class="property-group">
                        <label>Tent Name:</label>
                        <input type="text" id="tentName" value="${selectedTent.name}"
                               onchange="updateTentName(this.value)">
                    </div>
                    <div class="property-group">
                        <label>Shape:</label>
                        <input type="text" value="Square" disabled>
                    </div>
                    <div class="property-group">
                        <label>Color:</label>
                        <div class="color-palette">${colorOptions}</div>
                    </div>
                    <div class="property-group">
                        <label>Size (Width x Height in feet):</label>
                        <div class="size-inputs">
                            <input type="number" id="tentWidth" value="${widthFeet}"
                                   min="2" step="0.5" onchange="updateTentSize()">
                            <input type="number" id="tentHeight" value="${heightFeet}"
                                   min="2" step="0.5" onchange="updateTentSize()">
                        </div>
                    </div>
                    <div class="property-group">
                        <label>Rotation (degrees):</label>
                        <input type="number" id="tentRotation" value="${Math.round(selectedTent.rotation)}"
                               min="0" max="359" onchange="updateTentRotation()">
                    </div>
                    <div class="property-group">
                        <label>Position (X, Y):</label>
                        <div class="size-inputs">
                            <input type="number" id="tentX" value="${Math.round(selectedTent.x)}"
                                   min="0" onchange="updateTentPosition()">
                            <input type="number" id="tentY" value="${Math.round(selectedTent.y)}"
                                   min="0" onchange="updateTentPosition()">
                        </div>
                    </div>
                `;
            }
        }

        function updateTentName(name) {
            if (selectedTent) {
                selectedTent.name = name;
                const tentEl = document.getElementById(selectedTent.id);
                const label = tentEl.querySelector('.tent-label');
                const colorScheme = tentColors[selectedTent.color] || tentColors.tan;
                const sizeText = label.querySelector('.tent-size').outerHTML;
                label.innerHTML = name + sizeText;
                label.style.color = colorScheme.textColor;
                updateTentList();
                scheduleFirestoreSave();
            }
        }

        function updateTentSize() {
            if (selectedTent) {
                const widthFeet = parseFloat(document.getElementById('tentWidth').value);
                const heightFeet = parseFloat(document.getElementById('tentHeight').value);
                selectedTent.width = Math.max(feetToPixels(2), feetToPixels(widthFeet));
                selectedTent.height = Math.max(feetToPixels(2), feetToPixels(heightFeet));

                const tentEl = document.getElementById(selectedTent.id);
                tentEl.style.width = selectedTent.width + 'px';
                tentEl.style.height = selectedTent.height + 'px';

                const sizeLabel = tentEl.querySelector('.tent-size');
                if (sizeLabel) {
                    const newWidthFeet = pixelsToFeet(selectedTent.width);
                    const newHeightFeet = pixelsToFeet(selectedTent.height);
                    sizeLabel.textContent = `${newWidthFeet}x${newHeightFeet}ft`;
                }
                scheduleFirestoreSave();
            }
        }

        function updateTentDiameter() {
            if (selectedTent && selectedTent.shape === 'round') {
                const diameterFeet = parseFloat(document.getElementById('tentDiameter').value);
                const diameter = Math.max(feetToPixels(2), feetToPixels(diameterFeet));
                selectedTent.width = diameter;
                selectedTent.height = diameter;

                const tentEl = document.getElementById(selectedTent.id);
                tentEl.style.width = diameter + 'px';
                tentEl.style.height = diameter + 'px';

                const sizeLabel = tentEl.querySelector('.tent-size');
                if (sizeLabel) {
                    const newDiameterFeet = pixelsToFeet(diameter);
                    sizeLabel.textContent = `${newDiameterFeet}ft diameter`;
                }
                scheduleFirestoreSave();
            }
        }

        function updateTentRotation() {
            if (selectedTent && selectedTent.shape === 'square') {
                let rotation = parseInt(document.getElementById('tentRotation').value);
                rotation = ((rotation % 360) + 360) % 360;
                selectedTent.rotation = rotation;

                const tentEl = document.getElementById(selectedTent.id);
                tentEl.style.transform = `rotate(${rotation}deg)`;
                scheduleFirestoreSave();
            }
        }

        function updateTentPosition() {
            if (selectedTent) {
                const x = parseInt(document.getElementById('tentX').value);
                const y = parseInt(document.getElementById('tentY').value);
                selectedTent.x = Math.max(0, x);
                selectedTent.y = Math.max(0, y);

                const tentEl = document.getElementById(selectedTent.id);
                tentEl.style.left = selectedTent.x + 'px';
                tentEl.style.top = selectedTent.y + 'px';
                scheduleFirestoreSave();
            }
        }

        function updateTentList() {
            const listEl = document.getElementById('tentList');
            listEl.innerHTML = tents.map(tent => {
                const widthFeet = pixelsToFeet(tent.width);
                const heightFeet = pixelsToFeet(tent.height);
                const sizeText = tent.shape === 'round' ? `${widthFeet}ft` : `${widthFeet}x${heightFeet}ft`;

                return `
                    <div class="tent-item ${tent === selectedTent ? 'selected' : ''}"
                         onclick="selectTentById('${tent.id}')">
                        <div class="tent-item-name">${tent.name}</div>
                        <div class="tent-item-size">${sizeText}</div>
                    </div>
                `;
            }).join('');
        }

        function selectTentById(id) {
            const tent = tents.find(t => t.id === id);
            if (tent) selectTent(tent);
        }

        function deleteSelected() {
            if (selectedTent) {
                const tentEl = document.getElementById(selectedTent.id);
                tentEl.remove();
                tents = tents.filter(t => t.id !== selectedTent.id);
                selectedTent = null;
                updateProperties();
                updateTentList();
                scheduleFirestoreSave();
            }
        }

        function clearAll() {
            if (confirm('Clear all tents, lines, and drawings?')) {
                tents = [];
                lines = [];
                pencilStrokes = [];
                selectedTent = null;
                canvas.innerHTML = '<canvas class="drawing-canvas" id="pencilCanvas"></canvas><canvas class="drawing-canvas" id="drawingCanvas"></canvas><svg class="grid-overlay" id="gridOverlay"></svg>';

                drawingCanvas = document.getElementById('drawingCanvas');
                drawingCtx = drawingCanvas.getContext('2d');
                drawingCanvas.width = canvas.offsetWidth;
                drawingCanvas.height = canvas.offsetHeight;
                drawingCtx.lineWidth = 2;
                drawingCtx.lineCap = 'round';
                drawingCtx.strokeStyle = '#4a3728';

                pencilCanvas = document.getElementById('pencilCanvas');
                pencilCtx = pencilCanvas.getContext('2d');
                pencilCanvas.width = canvas.offsetWidth;
                pencilCanvas.height = canvas.offsetHeight;
                pencilCtx.lineWidth = 3;
                pencilCtx.lineCap = 'round';
                pencilCtx.strokeStyle = '#8B0000';

                updateProperties();
                updateTentList();
                scheduleFirestoreSave();
            }
        }

        function exportLayout() {
            const mapSizeSelect = document.getElementById('mapSizeSelect');
            const mapSize = mapSizeSelect ? mapSizeSelect.value : '3000x2000';
            const data = {
                tents: tents.map(tent => ({
                    ...tent,
                    widthFeet: pixelsToFeet(tent.width),
                    heightFeet: pixelsToFeet(tent.height)
                })),
                lines: lines,
                pencilStrokes: pencilStrokes,
                backgroundImage: backgroundImage,
                backgroundSize: backgroundSize,
                compassDirection: compassDirection,
                mapSize: mapSize
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'occidental-camp-layout.json';
            a.click();
        }

        function handleJsonUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    loadLayout(data);
                    scheduleFirestoreSave();
                    alert('Layout loaded successfully!');
                } catch (error) {
                    alert('Error loading layout: Invalid JSON file');
                    console.error('Error loading layout:', error);
                }
            };
            reader.readAsText(file);

            event.target.value = '';
        }

        function loadLayout(data) {
            tents = [];
            lines = [];
            pencilStrokes = [];
            selectedTent = null;

            // Restore map size FIRST before setting up canvases
            if (data.mapSize) {
                const mapSizeSelect = document.getElementById('mapSizeSelect');
                if (mapSizeSelect) {
                    mapSizeSelect.value = data.mapSize;
                }
                const [width, height] = data.mapSize.split('x').map(Number);
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                localStorage.setItem('occidentalMapSize', data.mapSize);
            }

            canvas.innerHTML = '<canvas class="drawing-canvas" id="pencilCanvas"></canvas><canvas class="drawing-canvas" id="drawingCanvas"></canvas><svg class="grid-overlay" id="gridOverlay"></svg>';

            drawingCanvas = document.getElementById('drawingCanvas');
            drawingCtx = drawingCanvas.getContext('2d');
            drawingCanvas.width = canvas.offsetWidth;
            drawingCanvas.height = canvas.offsetHeight;
            drawingCtx.lineWidth = 2;
            drawingCtx.lineCap = 'round';
            drawingCtx.strokeStyle = '#4a3728';

            pencilCanvas = document.getElementById('pencilCanvas');
            pencilCtx = pencilCanvas.getContext('2d');
            pencilCanvas.width = canvas.offsetWidth;
            pencilCanvas.height = canvas.offsetHeight;
            pencilCtx.lineWidth = 3;
            pencilCtx.lineCap = 'round';
            pencilCtx.strokeStyle = '#8B0000';

            if (data.tents) {
                tentCounter = 1;
                data.tents.forEach(tentData => {
                    const tent = {
                        id: `tent-${tentCounter++}`,
                        name: tentData.name || `Tent ${tentCounter - 1}`,
                        x: tentData.x || 100,
                        y: tentData.y || 100,
                        width: tentData.width || 120,
                        height: tentData.height || 120,
                        shape: tentData.shape || 'square',
                        rotation: tentData.rotation || 0,
                        color: tentData.color || 'tan',
                        zIndex: tents.length
                    };
                    tents.push(tent);
                    renderTent(tent);
                });
            }

            if (data.lines) {
                lines = data.lines;
                redrawLines();
            }

            if (data.pencilStrokes) {
                pencilStrokes = data.pencilStrokes;
                redrawPencil();
            }

            if (data.backgroundImage) {
                backgroundImage = data.backgroundImage;
                canvas.style.backgroundImage = `url(${backgroundImage})`;
                backgroundSize = data.backgroundSize || 100;
                canvas.style.backgroundSize = backgroundSize + '%';
                document.getElementById('bgControls').style.display = 'block';
                document.getElementById('bgSizeDisplay').textContent = backgroundSize + '%';
            } else {
                removeBackground();
            }

            if (data.compassDirection) {
                compassDirection = data.compassDirection;
                const dirIndex = compassDirections.findIndex(d => d.letter === compassDirection);
                if (dirIndex >= 0) {
                    compassIndex = dirIndex;
                    document.getElementById('compassLetter').textContent = compassDirections[dirIndex].letter;
                    document.getElementById('compassLabel').textContent = compassDirections[dirIndex].label;
                }
            }

            updateTentList();
            updateProperties();
        }

        // Browser localStorage save/load functions
        const STORAGE_KEY = 'occidentalCampLayout';

        function saveToBrowser() {
            const mapSizeSelect = document.getElementById('mapSizeSelect');
            const mapSize = mapSizeSelect ? mapSizeSelect.value : '3000x2000';
            const data = {
                tents: tents.map(tent => ({
                    ...tent,
                    widthFeet: pixelsToFeet(tent.width),
                    heightFeet: pixelsToFeet(tent.height)
                })),
                lines: lines,
                pencilStrokes: pencilStrokes,
                backgroundImage: backgroundImage,
                backgroundSize: backgroundSize,
                compassDirection: compassDirection,
                mapSize: mapSize,
                savedAt: new Date().toISOString()
            };

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                alert('Camp layout saved to browser storage!');
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    alert('Unable to save: Storage quota exceeded. Try removing the background image or clearing browser data.');
                } else {
                    alert('Error saving layout: ' + error.message);
                }
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadFromBrowser() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (!savedData) {
                    alert('No saved layout found in browser storage.');
                    return;
                }

                const data = JSON.parse(savedData);
                const savedDate = data.savedAt ? new Date(data.savedAt).toLocaleString() : 'Unknown';

                if (confirm(`Load saved layout from ${savedDate}?\n\nThis will replace your current layout.`)) {
                    loadLayout(data);
                    alert('Layout loaded successfully!');
                }
            } catch (error) {
                alert('Error loading saved layout: ' + error.message);
                console.error('Error loading from localStorage:', error);
            }
        }

        function clearBrowserSave() {
            if (confirm('Remove saved layout from browser storage?')) {
                localStorage.removeItem(STORAGE_KEY);
                alert('Saved layout removed from browser storage.');
            }
        }

        // Export as image function
        function exportAsImage() {
            // Create a temporary canvas to composite all layers
            const exportCanvas = document.createElement('canvas');
            const canvasWidth = 3000;
            const canvasHeight = 2000;
            exportCanvas.width = canvasWidth;
            exportCanvas.height = canvasHeight;
            const ctx = exportCanvas.getContext('2d');

            // Draw background gradient (sandy to green)
            const gradient = ctx.createLinearGradient(0, 0, 0, canvasHeight);
            gradient.addColorStop(0, '#c2b280');
            gradient.addColorStop(1, '#8fbc8f');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Draw background image if exists
            if (backgroundImage) {
                const img = new Image();
                img.onload = function() {
                    const imgWidth = (img.width * backgroundSize) / 100;
                    const imgHeight = (img.height * backgroundSize) / 100;
                    const imgX = (canvasWidth - imgWidth) / 2;
                    const imgY = (canvasHeight - imgHeight) / 2;
                    ctx.drawImage(img, imgX, imgY, imgWidth, imgHeight);
                    continueExport();
                };
                img.src = backgroundImage;
            } else {
                continueExport();
            }

            function continueExport() {
                // Draw pencil strokes
                ctx.strokeStyle = '#8B0000';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                pencilStrokes.forEach(stroke => {
                    if (stroke.length < 2) return;
                    ctx.beginPath();
                    ctx.moveTo(stroke[0].x, stroke[0].y);
                    for (let i = 1; i < stroke.length; i++) {
                        ctx.lineTo(stroke[i].x, stroke[i].y);
                    }
                    ctx.stroke();
                });

                // Draw lines with labels
                ctx.strokeStyle = '#4a3728';
                ctx.lineWidth = 2;
                lines.forEach(line => {
                    ctx.beginPath();
                    ctx.moveTo(line.x1, line.y1);
                    ctx.lineTo(line.x2, line.y2);
                    ctx.stroke();

                    // Draw distance label
                    const midX = (line.x1 + line.x2) / 2;
                    const midY = (line.y1 + line.y2) / 2;
                    const distanceFeet = line.distance.toFixed(1);
                    ctx.font = 'bold 12px Arial';
                    const textWidth = ctx.measureText(distanceFeet + ' ft').width;

                    ctx.fillStyle = 'rgba(74, 55, 40, 0.9)';
                    ctx.fillRect(midX - textWidth/2 - 4, midY - 8, textWidth + 8, 16);

                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(distanceFeet + ' ft', midX, midY);
                });

                // Draw tents
                tents.forEach(tent => {
                    ctx.save();

                    const centerX = tent.x + tent.width / 2;
                    const centerY = tent.y + tent.height / 2;

                    ctx.translate(centerX, centerY);
                    ctx.rotate((tent.rotation * Math.PI) / 180);
                    ctx.translate(-centerX, -centerY);

                    const colorScheme = tentColors[tent.color] || tentColors.tan;

                    // Draw tent shape
                    ctx.fillStyle = colorScheme.bg;
                    ctx.strokeStyle = colorScheme.border;
                    ctx.lineWidth = 3;

                    if (tent.shape === 'round') {
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, tent.width / 2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                    } else {
                        ctx.beginPath();
                        ctx.roundRect(tent.x, tent.y, tent.width, tent.height, 8);
                        ctx.fill();
                        ctx.stroke();
                    }

                    // Draw tent label
                    ctx.fillStyle = colorScheme.textColor;
                    ctx.font = 'bold 14px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(tent.name, centerX, centerY - 8);

                    // Draw size text
                    ctx.font = '11px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
                    ctx.fillStyle = colorScheme.textColor;
                    ctx.globalAlpha = 0.8;
                    const widthFeet = pixelsToFeet(tent.width);
                    const heightFeet = pixelsToFeet(tent.height);
                    const sizeText = tent.shape === 'round' ? `${widthFeet}ft diameter` : `${widthFeet}x${heightFeet}ft`;
                    ctx.fillText(sizeText, centerX, centerY + 10);
                    ctx.globalAlpha = 1;

                    ctx.restore();
                });

                // Draw compass indicator
                ctx.save();
                const compassX = canvasWidth / 2;
                const compassY = 40;

                // Compass background
                ctx.fillStyle = '#f5deb3';
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(compassX, compassY, 25, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();

                // Compass letter
                ctx.fillStyle = '#4a3728';
                ctx.font = 'bold 16px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(compassDirection, compassX, compassY - 2);

                // Compass label
                const directionLabels = { 'N': 'North', 'E': 'East', 'S': 'South', 'W': 'West' };
                ctx.font = '7px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
                ctx.fillStyle = '#666';
                ctx.fillText(directionLabels[compassDirection] || '', compassX, compassY + 12);
                ctx.restore();

                // Create download link
                const link = document.createElement('a');
                link.download = 'occidental-camp-layout.png';
                link.href = exportCanvas.toDataURL('image/png');
                link.click();
            }
        }

        // Initialize drawing canvas
        drawingCanvas = document.getElementById('drawingCanvas');
        drawingCtx = drawingCanvas.getContext('2d');
        drawingCanvas.width = canvas.offsetWidth;
        drawingCanvas.height = canvas.offsetHeight;
        drawingCtx.lineWidth = 2;
        drawingCtx.lineCap = 'round';
        drawingCtx.strokeStyle = '#4a3728';

        // Initialize pencil canvas
        pencilCanvas = document.getElementById('pencilCanvas');
        pencilCtx = pencilCanvas.getContext('2d');
        pencilCanvas.width = canvas.offsetWidth;
        pencilCanvas.height = canvas.offsetHeight;
        pencilCtx.lineWidth = 3;
        pencilCtx.lineCap = 'round';
        pencilCtx.strokeStyle = '#8B0000';

        // Pencil tool functions
        function togglePencilTool() {
            pencilMode = !pencilMode;
            const pencilBtn = document.getElementById('pencilBtn');
            const lineBtn = document.getElementById('lineBtn');
            const deletePencilBtn = document.getElementById('deletePencilBtn');
            const canvasEl = document.getElementById('canvas');

            if (pencilMode) {
                if (lineMode) {
                    lineMode = false;
                    lineBtn.classList.remove('active');
                    canvasEl.classList.remove('line-mode');
                    drawingCanvas.classList.remove('active');
                    removeLinePreview();
                }

                if (deletePencilMode) {
                    deletePencilMode = false;
                    deletePencilBtn.classList.remove('active');
                }
                if (deleteLineMode) {
                    deleteLineMode = false;
                    document.getElementById('deleteLineBtn').classList.remove('active');
                }

                pencilBtn.classList.add('active');
                canvasEl.classList.add('pencil-mode');
                pencilCanvas.classList.add('pencil-active');
            } else {
                pencilBtn.classList.remove('active');
                canvasEl.classList.remove('pencil-mode');
                pencilCanvas.classList.remove('pencil-active');
            }
        }

        function toggleDeletePencilMode() {
            deletePencilMode = !deletePencilMode;
            const deletePencilBtn = document.getElementById('deletePencilBtn');
            const pencilBtn = document.getElementById('pencilBtn');
            const canvasEl = document.getElementById('canvas');

            if (deletePencilMode) {
                if (pencilMode) {
                    pencilMode = false;
                    pencilBtn.classList.remove('active');
                    canvasEl.classList.remove('pencil-mode');
                    pencilCanvas.classList.remove('pencil-active');
                }
                if (lineMode) {
                    lineMode = false;
                    document.getElementById('lineBtn').classList.remove('active');
                    canvasEl.classList.remove('line-mode');
                    drawingCanvas.classList.remove('active');
                    removeLinePreview();
                }
                if (deleteLineMode) {
                    deleteLineMode = false;
                    document.getElementById('deleteLineBtn').classList.remove('active');
                }

                deletePencilBtn.classList.add('active');
                pencilCanvas.classList.add('pencil-active');
            } else {
                deletePencilBtn.classList.remove('active');
                pencilCanvas.classList.remove('pencil-active');
            }
        }

        function redrawPencil() {
            pencilCtx.clearRect(0, 0, pencilCanvas.width, pencilCanvas.height);
            pencilCtx.strokeStyle = '#8B0000';
            pencilCtx.lineWidth = 3;
            pencilCtx.lineCap = 'round';

            pencilStrokes.forEach(stroke => {
                if (stroke.length < 2) return;
                pencilCtx.beginPath();
                pencilCtx.moveTo(stroke[0].x, stroke[0].y);
                for (let i = 1; i < stroke.length; i++) {
                    pencilCtx.lineTo(stroke[i].x, stroke[i].y);
                }
                pencilCtx.stroke();
            });
        }

        function isPointNearStroke(x, y, stroke, threshold = 10) {
            for (let i = 0; i < stroke.length - 1; i++) {
                const p1 = stroke[i];
                const p2 = stroke[i + 1];
                const distance = distanceToLineSegment(x, y, p1.x, p1.y, p2.x, p2.y);
                if (distance < threshold) return true;
            }
            return false;
        }

        function distanceToLineSegment(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;

            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;

            if (lenSq !== 0) param = dot / lenSq;

            let xx, yy;

            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }

            const dx = px - xx;
            const dy = py - yy;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Pencil drawing event handlers
        pencilCanvas.addEventListener('mousedown', (e) => {
            const rect = pencilCanvas.getBoundingClientRect();
            const clickX = (e.clientX - rect.left) / zoomLevel;
            const clickY = (e.clientY - rect.top) / zoomLevel;

            if (deletePencilMode) {
                for (let i = pencilStrokes.length - 1; i >= 0; i--) {
                    if (isPointNearStroke(clickX, clickY, pencilStrokes[i])) {
                        pencilStrokes.splice(i, 1);
                        redrawPencil();
                        scheduleFirestoreSave();
                        return;
                    }
                }
                return;
            }

            if (!pencilMode) return;

            isDrawing = true;
            currentStroke = [{x: clickX, y: clickY}];
            lastPencilX = clickX;
            lastPencilY = clickY;
        });

        pencilCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawing || !pencilMode) return;
            const rect = pencilCanvas.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) / zoomLevel;
            const currentY = (e.clientY - rect.top) / zoomLevel;

            currentStroke.push({x: currentX, y: currentY});

            pencilCtx.beginPath();
            pencilCtx.moveTo(lastPencilX, lastPencilY);
            pencilCtx.lineTo(currentX, currentY);
            pencilCtx.stroke();

            lastPencilX = currentX;
            lastPencilY = currentY;
        });

        pencilCanvas.addEventListener('mouseup', () => {
            if (isDrawing && currentStroke.length > 1) {
                pencilStrokes.push(currentStroke);
                currentStroke = [];
                scheduleFirestoreSave();
            }
            isDrawing = false;
        });

        pencilCanvas.addEventListener('mouseleave', () => {
            if (isDrawing && currentStroke.length > 1) {
                pencilStrokes.push(currentStroke);
                currentStroke = [];
                scheduleFirestoreSave();
            }
            isDrawing = false;
        });

        // Touch support for pencil
        pencilCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = pencilCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const clickX = (touch.clientX - rect.left) / zoomLevel;
            const clickY = (touch.clientY - rect.top) / zoomLevel;

            if (deletePencilMode) {
                for (let i = pencilStrokes.length - 1; i >= 0; i--) {
                    if (isPointNearStroke(clickX, clickY, pencilStrokes[i])) {
                        pencilStrokes.splice(i, 1);
                        redrawPencil();
                        scheduleFirestoreSave();
                        return;
                    }
                }
                return;
            }

            if (!pencilMode) return;

            isDrawing = true;
            currentStroke = [{x: clickX, y: clickY}];
            lastPencilX = clickX;
            lastPencilY = clickY;
        });

        pencilCanvas.addEventListener('touchmove', (e) => {
            if (!isDrawing || !pencilMode) return;
            e.preventDefault();
            const rect = pencilCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const currentX = (touch.clientX - rect.left) / zoomLevel;
            const currentY = (touch.clientY - rect.top) / zoomLevel;

            currentStroke.push({x: currentX, y: currentY});

            pencilCtx.beginPath();
            pencilCtx.moveTo(lastPencilX, lastPencilY);
            pencilCtx.lineTo(currentX, currentY);
            pencilCtx.stroke();

            lastPencilX = currentX;
            lastPencilY = currentY;
        });

        pencilCanvas.addEventListener('touchend', () => {
            if (isDrawing && currentStroke.length > 1) {
                pencilStrokes.push(currentStroke);
                currentStroke = [];
                scheduleFirestoreSave();
            }
            isDrawing = false;
        });

        // Line tool functions
        function toggleLineTool() {
            lineMode = !lineMode;
            const btn = document.getElementById('lineBtn');
            const pencilBtn = document.getElementById('pencilBtn');
            const deleteLineBtn = document.getElementById('deleteLineBtn');
            const canvasEl = document.getElementById('canvas');

            if (lineMode) {
                if (pencilMode) {
                    pencilMode = false;
                    pencilBtn.classList.remove('active');
                    canvasEl.classList.remove('pencil-mode');
                    pencilCanvas.classList.remove('pencil-active');
                }

                if (deletePencilMode) {
                    deletePencilMode = false;
                    document.getElementById('deletePencilBtn').classList.remove('active');
                }
                if (deleteLineMode) {
                    deleteLineMode = false;
                    deleteLineBtn.classList.remove('active');
                }

                btn.classList.add('active');
                canvasEl.classList.add('line-mode');
                drawingCanvas.classList.add('active');
            } else {
                btn.classList.remove('active');
                canvasEl.classList.remove('line-mode');
                drawingCanvas.classList.remove('active');
                removeLinePreview();
            }
        }

        function toggleDeleteLineMode() {
            deleteLineMode = !deleteLineMode;
            const deleteLineBtn = document.getElementById('deleteLineBtn');
            const lineBtn = document.getElementById('lineBtn');
            const canvasEl = document.getElementById('canvas');

            if (deleteLineMode) {
                if (lineMode) {
                    lineMode = false;
                    lineBtn.classList.remove('active');
                    canvasEl.classList.remove('line-mode');
                    drawingCanvas.classList.remove('active');
                    removeLinePreview();
                }
                if (pencilMode) {
                    pencilMode = false;
                    document.getElementById('pencilBtn').classList.remove('active');
                    canvasEl.classList.remove('pencil-mode');
                    pencilCanvas.classList.remove('pencil-active');
                }
                if (deletePencilMode) {
                    deletePencilMode = false;
                    document.getElementById('deletePencilBtn').classList.remove('active');
                }

                deleteLineBtn.classList.add('active');
                drawingCanvas.classList.add('active');
            } else {
                deleteLineBtn.classList.remove('active');
                drawingCanvas.classList.remove('active');
            }
        }

        function clearLines() {
            lines = [];
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        }

        function isPointNearLine(x, y, line, threshold = 15) {
            return distanceToLineSegment(x, y, line.x1, line.y1, line.x2, line.y2) < threshold;
        }

        function redrawLines() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            drawingCtx.strokeStyle = '#4a3728';
            drawingCtx.lineWidth = 2;

            lines.forEach(line => {
                drawingCtx.beginPath();
                drawingCtx.moveTo(line.x1, line.y1);
                drawingCtx.lineTo(line.x2, line.y2);
                drawingCtx.stroke();

                const midX = (line.x1 + line.x2) / 2;
                const midY = (line.y1 + line.y2) / 2;
                drawingCtx.fillStyle = 'rgba(74, 55, 40, 0.9)';
                drawingCtx.font = 'bold 12px Arial';
                drawingCtx.textAlign = 'center';
                drawingCtx.textBaseline = 'middle';

                const distanceFeet = line.distance.toFixed(1);
                const textWidth = drawingCtx.measureText(distanceFeet + ' ft').width;
                drawingCtx.fillRect(midX - textWidth/2 - 4, midY - 8, textWidth + 8, 16);

                drawingCtx.fillStyle = 'white';
                drawingCtx.fillText(distanceFeet + ' ft', midX, midY);
            });
        }

        function createLinePreview() {
            if (!linePreview) {
                linePreview = document.createElement('div');
                linePreview.className = 'line-preview';
                canvas.appendChild(linePreview);
            }
            if (!lineLabel) {
                lineLabel = document.createElement('div');
                lineLabel.className = 'line-label';
                canvas.appendChild(lineLabel);
            }
        }

        function removeLinePreview() {
            if (linePreview) {
                linePreview.remove();
                linePreview = null;
            }
            if (lineLabel) {
                lineLabel.remove();
                lineLabel = null;
            }
        }

        function updateLinePreview(x1, y1, x2, y2) {
            if (!linePreview) createLinePreview();

            const dx = x2 - x1;
            const dy = y2 - y1;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;

            linePreview.style.left = x1 + 'px';
            linePreview.style.top = y1 + 'px';
            linePreview.style.width = length + 'px';
            linePreview.style.transform = `rotate(${angle}deg)`;

            const distanceFeet = pixelsToFeet(length);

            const midX = (x1 + x2) / 2;
            const midY = (y1 + y2) / 2;
            lineLabel.style.left = midX + 'px';
            lineLabel.style.top = (midY - 20) + 'px';
            lineLabel.textContent = distanceFeet.toFixed(1) + ' ft';
        }

        // Background functions
        function handleBackgroundUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    backgroundImage = e.target.result;
                    canvas.style.backgroundImage = `url(${backgroundImage})`;
                    canvas.style.backgroundSize = backgroundSize + '%';
                    document.getElementById('bgControls').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function removeBackground() {
            canvas.style.backgroundImage = 'none';
            backgroundImage = null;
            backgroundSize = 100;
            document.getElementById('bgImageUpload').value = '';
            document.getElementById('bgControls').style.display = 'none';
            document.getElementById('bgSizeDisplay').textContent = '100%';
            scheduleFirestoreSave();
        }

        function adjustBackgroundSize(delta) {
            backgroundSize = Math.max(10, Math.min(500, backgroundSize + delta));
            canvas.style.backgroundSize = backgroundSize + '%';
            document.getElementById('bgSizeDisplay').textContent = backgroundSize + '%';
            scheduleFirestoreSave();
        }

        // Line drawing event handlers
        drawingCanvas.addEventListener('mousedown', (e) => {
            const rect = drawingCanvas.getBoundingClientRect();
            const clickX = (e.clientX - rect.left) / zoomLevel;
            const clickY = (e.clientY - rect.top) / zoomLevel;

            if (deleteLineMode) {
                for (let i = lines.length - 1; i >= 0; i--) {
                    if (isPointNearLine(clickX, clickY, lines[i])) {
                        lines.splice(i, 1);
                        redrawLines();
                        scheduleFirestoreSave();
                        return;
                    }
                }
                return;
            }

            if (!lineMode) return;

            lineStartX = clickX;
            lineStartY = clickY;
            isDrawing = true;
            createLinePreview();
        });

        drawingCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawing || !lineMode) return;
            const rect = drawingCanvas.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) / zoomLevel;
            const currentY = (e.clientY - rect.top) / zoomLevel;
            updateLinePreview(lineStartX, lineStartY, currentX, currentY);
        });

        drawingCanvas.addEventListener('mouseup', (e) => {
            if (!isDrawing || !lineMode) return;
            const rect = drawingCanvas.getBoundingClientRect();
            const endX = (e.clientX - rect.left) / zoomLevel;
            const endY = (e.clientY - rect.top) / zoomLevel;

            const dx = endX - lineStartX;
            const dy = endY - lineStartY;
            const distancePixels = Math.sqrt(dx * dx + dy * dy);
            const distanceFeet = pixelsToFeet(distancePixels);

            if (distancePixels > 10) {
                lines.push({
                    x1: lineStartX,
                    y1: lineStartY,
                    x2: endX,
                    y2: endY,
                    distance: distanceFeet
                });
                redrawLines();
                scheduleFirestoreSave();
            }

            isDrawing = false;
            removeLinePreview();
        });

        drawingCanvas.addEventListener('mouseleave', (e) => {
            if (isDrawing && lineMode) {
                // Complete the line instead of cancelling
                const rect = drawingCanvas.getBoundingClientRect();
                const endX = (e.clientX - rect.left) / zoomLevel;
                const endY = (e.clientY - rect.top) / zoomLevel;

                const dx = endX - lineStartX;
                const dy = endY - lineStartY;
                const distancePixels = Math.sqrt(dx * dx + dy * dy);
                const distanceFeet = pixelsToFeet(distancePixels);

                if (distancePixels > 10) {
                    lines.push({
                        x1: lineStartX,
                        y1: lineStartY,
                        x2: endX,
                        y2: endY,
                        distance: distanceFeet
                    });
                    redrawLines();
                    scheduleFirestoreSave();
                }

                isDrawing = false;
                removeLinePreview();
            }
        });

        // Touch support for line drawing
        drawingCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = drawingCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const clickX = (touch.clientX - rect.left) / zoomLevel;
            const clickY = (touch.clientY - rect.top) / zoomLevel;

            if (deleteLineMode) {
                for (let i = lines.length - 1; i >= 0; i--) {
                    if (isPointNearLine(clickX, clickY, lines[i])) {
                        lines.splice(i, 1);
                        redrawLines();
                        scheduleFirestoreSave();
                        return;
                    }
                }
                return;
            }

            if (!lineMode) return;

            lineStartX = clickX;
            lineStartY = clickY;
            isDrawing = true;
            createLinePreview();
        });

        drawingCanvas.addEventListener('touchmove', (e) => {
            if (!isDrawing || !lineMode) return;
            e.preventDefault();
            const rect = drawingCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const currentX = (touch.clientX - rect.left) / zoomLevel;
            const currentY = (touch.clientY - rect.top) / zoomLevel;
            updateLinePreview(lineStartX, lineStartY, currentX, currentY);
        });

        drawingCanvas.addEventListener('touchend', (e) => {
            if (!isDrawing || !lineMode) return;
            e.preventDefault();
            const rect = drawingCanvas.getBoundingClientRect();
            const touch = e.changedTouches[0];
            const endX = (touch.clientX - rect.left) / zoomLevel;
            const endY = (touch.clientY - rect.top) / zoomLevel;

            const dx = endX - lineStartX;
            const dy = endY - lineStartY;
            const distancePixels = Math.sqrt(dx * dx + dy * dy);
            const distanceFeet = pixelsToFeet(distancePixels);

            if (distancePixels > 10) {
                lines.push({
                    x1: lineStartX,
                    y1: lineStartY,
                    x2: endX,
                    y2: endY,
                    distance: distanceFeet
                });
                redrawLines();
                scheduleFirestoreSave();
            }

            isDrawing = false;
            removeLinePreview();
        });

        // Initialize with default Occidental Camp layout
        function initializeOccidentalCamp() {
            // Set compass direction to North
            compassDirection = 'N';
            compassIndex = 0;
            document.getElementById('compassLetter').textContent = 'N';
            document.getElementById('compassLabel').textContent = 'North';

            // Open Area
            const open = {
                id: `tent-${tentCounter++}`,
                name: 'Open',
                x: 891.687,
                y: 254.83,
                width: 250,
                height: 1000,
                shape: 'square',
                rotation: 0,
                color: 'cream',
                zIndex: tents.length
            };
            tents.push(open);
            renderTent(open);

            // Michael Keal (large round)
            const michaelKeal1 = {
                id: `tent-${tentCounter++}`,
                name: 'Michael Keal',
                x: 1159.5,
                y: 510.422,
                width: 160,
                height: 160,
                shape: 'round',
                rotation: 0,
                color: 'darkgreen',
                zIndex: tents.length
            };
            tents.push(michaelKeal1);
            renderTent(michaelKeal1);

            // Michael Keal (small round)
            const michaelKeal2 = {
                id: `tent-${tentCounter++}`,
                name: 'Michael Keal',
                x: 1348.547,
                y: 493.219,
                width: 120,
                height: 120,
                shape: 'round',
                rotation: 0,
                color: 'darkgreen',
                zIndex: tents.length
            };
            tents.push(michaelKeal2);
            renderTent(michaelKeal2);

            // Sir Richard (main)
            const sirRichard1 = {
                id: `tent-${tentCounter++}`,
                name: 'Sir Richard',
                x: 1200.112,
                y: 1080.435,
                width: 200,
                height: 200,
                shape: 'square',
                rotation: 0,
                color: 'brown',
                zIndex: tents.length
            };
            tents.push(sirRichard1);
            renderTent(sirRichard1);

            // Sir Wolf
            const sirWolf = {
                id: `tent-${tentCounter++}`,
                name: 'Sir Wolf',
                x: 1172.219,
                y: 292.219,
                width: 200,
                height: 100,
                shape: 'square',
                rotation: 0,
                color: 'darkgreen',
                zIndex: tents.length
            };
            tents.push(sirWolf);
            renderTent(sirWolf);

            // Sir Gregor Pop up
            const sirGregor = {
                id: `tent-${tentCounter++}`,
                name: 'Sir Gregor Pop up',
                x: 1631.484,
                y: 616.792,
                width: 100,
                height: 100,
                shape: 'square',
                rotation: 0,
                color: 'darkred',
                zIndex: tents.length
            };
            tents.push(sirGregor);
            renderTent(sirGregor);

            // Rainulf Popup
            const rainulfPopup = {
                id: `tent-${tentCounter++}`,
                name: 'Rainulf Popup',
                x: 1515.12,
                y: 617.01,
                width: 100,
                height: 100,
                shape: 'square',
                rotation: 0,
                color: 'darkred',
                zIndex: tents.length
            };
            tents.push(rainulfPopup);
            renderTent(rainulfPopup);

            // Richard popup
            const richardPopup = {
                id: `tent-${tentCounter++}`,
                name: 'Richard popup',
                x: 1448.75,
                y: 1000.641,
                width: 100,
                height: 100,
                shape: 'square',
                rotation: 0,
                color: 'brown',
                zIndex: tents.length
            };
            tents.push(richardPopup);
            renderTent(richardPopup);

            // Fire pit
            const firePit = {
                id: `tent-${tentCounter++}`,
                name: 'Fire pit',
                x: 1625.609,
                y: 849.776,
                width: 100,
                height: 100,
                shape: 'round',
                rotation: 0,
                color: 'darkred',
                zIndex: tents.length
            };
            tents.push(firePit);
            renderTent(firePit);

            // Henry Kohnke
            const henryKohnke = {
                id: `tent-${tentCounter++}`,
                name: 'Henry Kohnke',
                x: 1922.76,
                y: 1168.266,
                width: 120,
                height: 100,
                shape: 'square',
                rotation: 0,
                color: 'tan',
                zIndex: tents.length
            };
            tents.push(henryKohnke);
            renderTent(henryKohnke);

            // Ryan Lunt
            const ryanLunt = {
                id: `tent-${tentCounter++}`,
                name: 'Ryan Lunt',
                x: 1929.292,
                y: 1065.13,
                width: 120,
                height: 80,
                shape: 'square',
                rotation: 0,
                color: 'tan',
                zIndex: tents.length
            };
            tents.push(ryanLunt);
            renderTent(ryanLunt);

            // Michael Keal Shade
            const michaelShade = {
                id: `tent-${tentCounter++}`,
                name: 'Michael Keal Shade',
                x: 1221.683,
                y: 669.079,
                width: 100,
                height: 160,
                shape: 'square',
                rotation: 57.478,
                color: 'darkgreen',
                zIndex: tents.length
            };
            tents.push(michaelShade);
            renderTent(michaelShade);

            // Sir Richard (shade)
            const sirRichard2 = {
                id: `tent-${tentCounter++}`,
                name: 'Sir Richard',
                x: 1444.844,
                y: 1121.641,
                width: 100,
                height: 160,
                shape: 'square',
                rotation: 0,
                color: 'brown',
                zIndex: tents.length
            };
            tents.push(sirRichard2);
            renderTent(sirRichard2);

            // Sir Wolf popup
            const sirWolfPopup = {
                id: `tent-${tentCounter++}`,
                name: 'Sir Wolf popup',
                x: 1390.938,
                y: 296.438,
                width: 100,
                height: 100,
                shape: 'square',
                rotation: 0,
                color: 'darkgreen',
                zIndex: tents.length
            };
            tents.push(sirWolfPopup);
            renderTent(sirWolfPopup);

            // BloodMoon
            const bloodMoon = {
                id: `tent-${tentCounter++}`,
                name: 'BloodMoon',
                x: 2074.969,
                y: 288.797,
                width: 800,
                height: 1000,
                shape: 'square',
                rotation: 0,
                color: 'darkred',
                zIndex: tents.length
            };
            tents.push(bloodMoon);
            renderTent(bloodMoon);

            // Rashidi
            const rashidi = {
                id: `tent-${tentCounter++}`,
                name: 'Rashidi',
                x: 1925,
                y: 931.667,
                width: 130,
                height: 120,
                shape: 'square',
                rotation: 0,
                color: 'tan',
                zIndex: tents.length
            };
            tents.push(rashidi);
            renderTent(rashidi);

            // Mavrick Tent
            const mavrick = {
                id: `tent-${tentCounter++}`,
                name: 'Mavrick Tent',
                x: 1928.333,
                y: 781.661,
                width: 120,
                height: 120,
                shape: 'square',
                rotation: 0,
                color: 'tan',
                zIndex: tents.length
            };
            tents.push(mavrick);
            renderTent(mavrick);

            // Justin & Celeste
            const justinCeleste = {
                id: `tent-${tentCounter++}`,
                name: 'Justin & Celeste',
                x: 1918.571,
                y: 601.185,
                width: 120,
                height: 140,
                shape: 'square',
                rotation: 0,
                color: 'tan',
                zIndex: tents.length
            };
            tents.push(justinCeleste);
            renderTent(justinCeleste);

            // Duncan and Liz
            const duncanLiz = {
                id: `tent-${tentCounter++}`,
                name: 'Duncan and Liz',
                x: 1873.333,
                y: 366.667,
                width: 190,
                height: 190,
                shape: 'round',
                rotation: 0,
                color: 'tan',
                zIndex: tents.length
            };
            tents.push(duncanLiz);
            renderTent(duncanLiz);

            // Duncan and Liz Awning
            const duncanLizAwning = {
                id: `tent-${tentCounter++}`,
                name: 'Duncan and Liz Awning',
                x: 1753.333,
                y: 415,
                width: 100,
                height: 100,
                shape: 'square',
                rotation: 0,
                color: 'tan',
                zIndex: tents.length
            };
            tents.push(duncanLizAwning);
            renderTent(duncanLizAwning);

            // Kitchen Area
            const kitchen = {
                id: `tent-${tentCounter++}`,
                name: 'Kitchen Area',
                x: 1520,
                y: 308.333,
                width: 200,
                height: 300,
                shape: 'square',
                rotation: 0,
                color: 'tan',
                zIndex: tents.length
            };
            tents.push(kitchen);
            renderTent(kitchen);

            // Sir Roger
            const sirRoger = {
                id: `tent-${tentCounter++}`,
                name: 'Sir Roger',
                x: 1289.763,
                y: 894.505,
                width: 140,
                height: 140,
                shape: 'square',
                rotation: 30.754,
                color: 'tan',
                zIndex: tents.length
            };
            tents.push(sirRoger);
            renderTent(sirRoger);

            // Add default measurement line (90 ft)
            lines.push({
                x1: 1152,
                y1: 266,
                x2: 2052,
                y2: 266,
                distance: 90
            });
            redrawLines();

            updateTentList();
        }

        // Initialization is handled by the Firebase auth state callback above:
        //   signed in  → _loadFromFirestore() (or initializeOccidentalCamp() on first run)
        //   signed out → login overlay remains visible
        // The login overlay shows by default via CSS until auth resolves.
    </script>
</body>
</html>
